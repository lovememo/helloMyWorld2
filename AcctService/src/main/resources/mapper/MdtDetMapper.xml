<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 指定工作空间，要与接口名相同，源代码没有去看，猜测应该是通过"这里的namespace.下边方法的id"来定位方法的 -->
<mapper namespace="com.opm.acct.mdt.mapper.MdtDetMapper">
<!-- 受托户会计明细账表 -->
	<resultMap id="mdtDet" type="com.opm.acct.mdt.model.MdtDetModel">
	    <result column="SEQ_ID" property="seqId"></result>
	    <result column="ACT_ID" property="actId"></result>
		<result column="OP_DATE" property="opDate"></result>
		<result column="MDT_SUBJECT_TYPE" property="mdtSubjectType"></result>
		<result column="DEBIT_CREDIT_FLAG" property="debitCreditFlag"></result>
		<result column="TRADE_AMT" property="tradeAmt"></result>
		<result column="TRD_NO" property="trdNo"></result>
		<result column="MEMO" property="memo"></result>
		<result column="SYS_TIME" property="sysTime"></result>
	</resultMap>
	
	<!-- 插入受托户会计明细账表 -->
	<insert id="insertMdtDet" parameterType="String">
	  INSERT INTO opm_mdt_det
            (seq_id, act_id, op_date, mdt_subject_type, debit_credit_flag, trade_amt, trd_no, memo, sys_time)
            SELECT seq_id.nextval,
                   act_id,
                   t.op_date,
                   t.mdt_subject_type,
                   t.debit_credit_flag,
                   t.trade_amt,
                   t.trd_no,
                   t.memo,
                   SYSDATE
              FROM opm_mdt_det_trd t
             WHERE t.trade_amt != 0 and trd_no = #{trdNo,jdbcType=VARCHAR}
    </insert>
    
	<!--  获取当期交易金额--> 
	<select id="getPreAmt" parameterType="String">
         SELECT nvl(SUM( CASE
            WHEN t.mdt_subject_type IN ('1002', '1204', '6404', '6405', '6605') THEN
                --资产、费用
                decode(t.debit_credit_flag, 1, 1, 2, -1) 
            WHEN t.mdt_subject_type IN ('2207', '2210', '2211', '2221', '6011', '4001', '4103', '4104') OR t.mdt_subject_type LIKE '2241%' THEN
                --负债、收入、权益类
                decode(t.debit_credit_flag, 2, 1, 1, -1) 
        END  * t.trade_amt), 0)
          FROM opm_mdt_det t
         WHERE t.act_id = #{actId,jdbcType=VARCHAR}
           AND t.mdt_subject_type = #{mdtSubjectType,jdbcType=VARCHAR}
           AND t.op_date > #{lastDate,jdbcType=VARCHAR}
           AND t.op_date &lt;= #{date,jdbcType=VARCHAR}
	</select>
	
	<!--  根据日期获取余额--> 
	<select id="getAmtByDate" parameterType="String">
         SELECT  nvl(SUM(CASE
                                       WHEN t.mdt_subject_type IN ('1002', '1204') THEN
                                        SELECT decode(t.debit_credit_flag, 1, 1, 2, -1) * t.trade_amt
                                       WHEN t.mdt_subject_type IN ('2207', '2210', '2211', '2221') OR t.mdt_subject_type LIKE '2241%' THEN
                                        -decode(t.debit_credit_flag, 2, 1, 1, -1) * t.trade_amt
                                   END), 0)
          FROM opm_mdt_det t
         WHERE t.op_date = #{date,jdbcType=VARCHAR}
           AND t.act_id = #{actId,jdbcType=VARCHAR}
           AND t.mdt_subject_type IN ('1002', '1204', '2207', '2210', '2211', '2221') OR t.mdt_subject_type LIKE '2241%' 
	</select>
	<!--  受托户冲账申请 受托户会计账务处理明细查询--> 
	<select id="qryMdtDetList" parameterType="String">
          SELECT seq_id,
                 act_id,
                 op_date,
                 mdt_subject_type,
                 debit_credit_flag,
                 trade_amt,
                 trd_no,
                 memo

                  FROM (SELECT seq_id,
                               act_id,
                               op_date,
                               mdt_subject_type,
                               debit_credit_flag,
                               trade_amt,
                               trd_no,
                               memo,
                               rownum rn
                          FROM (SELECT seq_id,
                                       act_id,
                                       op_date,
                                       mdt_subject_type,
                                       debit_credit_flag,
                                       trade_amt,
                                       trd_no,
                                       memo

                                  FROM opm_mdt_det t, mdt_act_inf a
                                 WHERE t.op_date = #{date,jdbcType=VARCHAR}
                                   AND (#{amt,jdbcType=VARCHAR} IS NULL OR #{amt,jdbcType=VARCHAR} = t.trade_amt)
                                   AND t.act_id = #{actId,jdbcType=VARCHAR}
                                   AND t.act_id = a.act_id 
                                   AND #{date,jdbcType=VARCHAR} >= a.act_date)
                         ORDER BY seq_id ASC)
                 WHERE rn >= #{beginNum,jdbcType=VARCHAR}
                   AND rn &lt; (#{beginNum,jdbcType=VARCHAR} + #{fetchNum,jdbcType=VARCHAR})
	</select>
		<!--  冲账日结判断--> 
	<select id="getCountForReverseAct" parameterType="String">
         SELECT COUNT(1)
          FROM opm_mdt_det t
         WHERE t.seq_id IN (SELECT seq_id FROM opm_mdt_adj_act_trd t WHERE t.trd_no = #{trdNo,jdbcType=VARCHAR})
           AND t.mdt_subject_type NOT IN ('1002', '1204', '2207', '2210', '2211', '2221') OR t.mdt_subject_type LIKE '2241%'
	</select>
		<!--  冲账获取最大操作日期--> 
	<select id="getMaxOpDateForReverseAct" parameterType="String">
         SELECT MAX(op_date)
          FROM opm_mdt_det t
         WHERE t.seq_id IN (SELECT seq_id FROM opm_mdt_adj_act_trd t WHERE t.trd_no = #{trdNo,jdbcType=VARCHAR})
	</select>
	<!--  受托户冲账申请复核  冲账申请查询--> 
	<select id="qryReverseActApp" parameterType="String">
         SELECT seq_id,
                       act_id,
                       op_date,
                        mdt_subject_type,
                        debit_credit_flag,
                       trade_amt,
                       memo

                  FROM opm_mdt_det t1
                 WHERE t1.seq_id IN (SELECT seq_id FROM opm_mdt_adj_act_trd t WHERE t.trd_no = #{trdNo,jdbcType=VARCHAR})
	</select>
</mapper>